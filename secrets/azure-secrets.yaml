id: "azure-secrets-001"
name: "Microsoft Azure Secrets Detection"
description: "Detects Azure credentials, connection strings, and API keys in source code"
category: "secrets"
severity: "critical"
author: "Valkyrie Community"
version: "1.0.0"
tags:
  - "azure"
  - "microsoft"
  - "credentials"
  - "secrets"
  - "cloud"
enabled: true

# Pattern definitions
patterns:
  - pattern: 'DefaultEndpointsProtocol=https;AccountName=[a-z0-9]{3,24};AccountKey=[A-Za-z0-9+/=]{88}'
    name: "Azure Storage Connection String with Key"
    entropy_threshold: 0.0
    keywords: ["azure", "storage", "connectionstring", "accountkey"]

  - pattern: 'AccountKey=[A-Za-z0-9+/=]{88}'
    name: "Azure Storage Account Key standalone"
    entropy_threshold: 4.2
    keywords: ["accountkey", "azure", "storage"]

  - pattern: '[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}'
    name: "Azure GUID pattern (TenantID, ClientID, etc.)"
    entropy_threshold: 3.5
    keywords: ["tenant", "client", "directory", "object", "id", "azure"]

  - pattern: '"clientSecret": "[A-Za-z0-9_~\\-]{40,}"'
    name: "Azure Client Secret in JSON"
    entropy_threshold: 4.0
    keywords: ["clientsecret", "azure", "ad", "active directory"]

  - pattern: 'Endpoint=sb://[a-z0-9\\-]+\\.servicebus\\.windows\\.net/;SharedAccessKeyName=[^;]+;SharedAccessKey=[A-Za-z0-9+/=]{43}'
    name: "Azure Service Bus Connection String"
    entropy_threshold: 0.0
    keywords: ["servicebus", "sharedaccesskey", "azure"]

  - pattern: 'SharedAccessKey=[A-Za-z0-9+/=]{43}'
    name: "Azure Shared Access Key standalone"
    entropy_threshold: 4.0
    keywords: ["sharedaccesskey", "sas", "azure"]

# File type restrictions
file_extensions:
  - ".json"
  - ".yaml"
  - ".yml"
  - ".xml"
  - ".config"
  - ".cs"          # C# files common in Azure environments
  - ".ps1"         # PowerShell scripts
  - ".tf"          # Terraform files
  - ".bicep"       # Azure Bicep files
  - ".env"
  - ".txt"
  - ".js"
  - ".ts"

# Exclude patterns to reduce false positives
exclude_patterns:
  - "test.*"
  - "example.*"
  - ".*template.*"
  - ".*sample.*"
  - ".*mock.*"
  - "00000000-0000-0000-0000-000000000000"  # Empty GUID

remediation: |
  Azure credentials and connection strings should never be hardcoded in source code.
  
  Recommended solutions:
  1. Use Azure Key Vault to store secrets and retrieve them at runtime
  2. Use Managed Identities for Azure resources
  3. Use Azure App Configuration for application settings
  4. Use environment variables for local development (never commit .env files)
  5. Implement Azure RBAC and follow principle of least privilege
  6. Regularly rotate keys and credentials using Azure automation

references:
  - "https://learn.microsoft.com/en-us/azure/key-vault/"
  - "https://learn.microsoft.com/en-us/azure/azure-app-configuration/"
  - "https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview"
  - "https://learn.microsoft.com/en-us/azure/security/fundamentals/best-practices-and-patterns"
