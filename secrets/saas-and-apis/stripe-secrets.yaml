id: "stripe-secrets-001"
name: "Stripe API Keys Detection"
description: "Detects Stripe API keys, webhook secrets, and payment credentials in source code"
category: "secrets"
severity: "critical"
author: "Valkyrie Community"
version: "1.0.0"
tags:
  - "stripe"
  - "payments"
  - "api-keys"
  - "secrets"
  - "financial"
  - "ecommerce"
enabled: true

# Pattern definitions
patterns:
  - pattern: '(sk|pk)_live_[0-9a-zA-Z]{24,}'
    name: "Stripe Live API Key"
    entropy_threshold: 0.0
    keywords: ["stripe", "live", "secret", "publishable", "key", "payment"]

  - pattern: '(sk|pk)_test_[0-9a-zA-Z]{24,}'
    name: "Stripe Test API Key"
    entropy_threshold: 0.0
    keywords: ["stripe", "test", "secret", "publishable", "key", "development"]

  - pattern: 'whsec_[0-9a-zA-Z]{24,}'
    name: "Stripe Webhook Signing Secret"
    entropy_threshold: 0.0
    keywords: ["stripe", "webhook", "whsec", "signing", "secret"]

  - pattern: 'rk_live_[0-9a-zA-Z]{24,}'
    name: "Stripe Restricted Key"
    entropy_threshold: 0.0
    keywords: ["stripe", "restricted", "key", "rk_live"]

  - pattern: 'ca_[0-9a-zA-Z]{24,}'
    name: "Stripe Connect Account ID"
    entropy_threshold: 0.0
    keywords: ["stripe", "connect", "account", "ca_"]

  - pattern: 'STRIPE_(SECRET|PUBLISHABLE)_KEY'
    name: "Stripe Environment Variable Pattern"
    entropy_threshold: 0.0
    keywords: ["stripe", "environment", "variable", "key"]

  - pattern: 'STRIPE_WEBHOOK_SECRET'
    name: "Stripe Webhook Environment Variable"
    entropy_threshold: 0.0
    keywords: ["stripe", "webhook", "secret", "environment"]

# File type restrictions
file_extensions:
  - ".env"
  - ".yml"
  - ".yaml"
  - ".json"
  - ".js"
  - ".ts"
  - ".py"
  - ".rb"
  - ".php"
  - ".java"
  - ".go"
  - ".config"
  - ".txt"
  - ".example"
  - ".template"

# Exclude patterns to reduce false positives
exclude_patterns:
  - "test.*"
  - "example.*"
  - ".*template.*"
  - ".*sample.*"
  - ".*mock.*"
  - "sk_test_example1234567890abcdef"
  - "pk_test_example1234567890abcdef"
  - "whsec_example1234567890abcdef"
  - "rk_live_example1234567890abcdef"

remediation: |
  Stripe API keys should never be hardcoded in source code due to severe financial risks.
  
  Recommended solutions:
  1. Use environment variables for all Stripe keys
  2. Store secrets in secure secret managers (AWS Secrets Manager, HashiCorp Vault, etc.)
  3. Use Stripe's restricted keys with minimal permissions
  4. Implement key rotation policies regularly
  5. Use different keys for development, staging, and production
  6. Monitor API key usage through Stripe Dashboard
  7. Immediately revoke compromised keys
  8. Use webhook signature verification to prevent replay attacks

references:
  - "https://stripe.com/docs/keys"
  - "https://stripe.com/docs/security"
  - "https://stripe.com/docs/webhooks/signatures"
  - "https://stripe.com/docs/development/dashboard/restricted-keys"
  - "https://stripe.com/docs/connect/authentication"
